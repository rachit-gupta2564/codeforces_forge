<h3><a href="https://codeforces.com/contest/2202/problem/C2" target="_blank" rel="noopener noreferrer">Lost Civilization (Hard Version)</a></h3>

<div class="header"><div class="title">C2. Lost Civilization (Hard Version)</div><div class="time-limit"><div class="property-title">time limit per test</div>2 seconds</div><div class="memory-limit"><div class="property-title">memory limit per test</div>256 megabytes</div><div class="input-file input-standard"><div class="property-title">input</div>standard input</div><div class="output-file output-standard"><div class="property-title">output</div>standard output</div></div><div><p>  </p><p><span class="tex-font-style-bf">This is the hard version of the problem. The difference between the versions is that in this version, you must compute the sum of values over all subsegments. You can hack only if you solved all versions of this problem.</span> </p><p>Let's define an algorithm to generate a sequence of $$$m+k$$$ integers as follows:</p><ol> <li> First, receive a sequence $$$x$$$ of $$$m$$$ integers as input. If $$$k=0$$$, terminate immediately and return the sequence $$$x$$$. </li><li> Then, select any index $$$1 \le i \le |x|$$$ and insert $$$(x_i+1)$$$ <span class="tex-font-style-bf">immediately after</span> the element $$$x_i$$$. </li><li> If $$$x$$$ contains exactly $$$m+k$$$ integers, terminate and return the sequence $$$x$$$. Otherwise, return to the second step. </li></ol><p>Alice knows that this algorithm was used by an ancient civilization in order to hide their secrets safely. Alice wants to learn the knowledge that they wanted to hide, but it is not an easy job to infer the input from the output of the algorithm.</p><p>For a sequence $$$b$$$ of $$$n$$$ integers, let us define $$$f(b)$$$ as the length of the <span class="tex-font-style-bf">shortest</span> sequence that could be given as an input for the algorithm to generate $$$b$$$.</p><p>Given a sequence $$$a$$$ of $$$n$$$ integers, please compute the value of the following sum</p><p>$$$$$$\sum_{l=1}^n {\sum_{r=l}^n {f([a_l,a_{l+1},\ldots,a_r])}}$$$$$$</p><p>In other words, you must find the sum of $$$f(c)$$$ over all <span class="tex-font-style-bf">subsegments</span>$$$^{\text{∗}}$$$ $$$c$$$ of $$$a$$$.</p><div class="statement-footnote"><p>$$$^{\text{∗}}$$$A sequence $$$a$$$ is a subsegment of a sequence $$$b$$$ if $$$a$$$ can be obtained from $$$b$$$ by the deletion of several (possibly, zero or all) elements from the beginning and several (possibly, zero or all) elements from the end. Two subsegments are considered different if the sets of <span class="tex-font-style-bf">positions</span> of the deleted elements are different. </p></div></div><div class="input-specification"><div class="section-title">Input</div><p>Each test contains multiple test cases. The first line contains the number of test cases $$$t$$$ ($$$1 \le t \le 10^4$$$). The description of the test cases follows. </p><p>The first line of each test case contains a single integer $$$n$$$ ($$$1 \le n \le 300\,000$$$).</p><p>The second line of each test case contains $$$n$$$ integers $$$a_1,a_2,\ldots,a_n$$$ ($$$1 \le a_i \le 10^9$$$).</p><p>It is guaranteed that the sum of $$$n$$$ over all test cases does not exceed $$$300\,000$$$.</p></div><div class="output-specification"><div class="section-title">Output</div><p>For each test case, output the answer on a separate line.</p></div><div class="sample-tests"><div class="section-title">Example</div><div class="sample-test"><div class="input"><div class="title">Input<div title="Copy" data-clipboard-target="#id0033085720424494713" id="id007471896360978489" class="input-output-copier">Copy</div></div><pre id="id0033085720424494713"><div class="test-example-line test-example-line-even test-example-line-0">5</div><div class="test-example-line test-example-line-odd test-example-line-1">5</div><div class="test-example-line test-example-line-odd test-example-line-1">1 2 3 4 5</div><div class="test-example-line test-example-line-even test-example-line-2">5</div><div class="test-example-line test-example-line-even test-example-line-2">1 3 5 7 9</div><div class="test-example-line test-example-line-odd test-example-line-3">5</div><div class="test-example-line test-example-line-odd test-example-line-3">1 2 5 6 5</div><div class="test-example-line test-example-line-even test-example-line-4">7</div><div class="test-example-line test-example-line-even test-example-line-4">1 2 4 5 3 7 8</div><div class="test-example-line test-example-line-odd test-example-line-5">9</div><div class="test-example-line test-example-line-odd test-example-line-5">9 8 9 2 3 4 4 5 3</div></pre></div><div class="output"><div class="title">Output<div title="Copy" data-clipboard-target="#id007533731060836262" id="id007942270309518461" class="input-output-copier">Copy</div></div><pre id="id007533731060836262"><div class="test-example-line test-example-line-odd test-example-line-1">15</div><div class="test-example-line test-example-line-even test-example-line-2">35</div><div class="test-example-line test-example-line-odd test-example-line-3">25</div><div class="test-example-line test-example-line-even test-example-line-4">60</div><div class="test-example-line test-example-line-odd test-example-line-5">78</div></pre></div></div></div><div class="note"><div class="section-title">Note</div><p>In the first test case, all subsegments of $$$a=[1,2,3,4,5]$$$ can be generated from a sequence of length $$$1$$$.</p><p>In the second test case, all subsegments of $$$a=[1,3,5,7,9]$$$ <span class="tex-font-style-bf">cannot</span> be generated from any shorter sequence than itself.</p></div>